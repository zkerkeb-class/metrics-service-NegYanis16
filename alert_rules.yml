groups:
  # ========================================
  # ALERTES TECHNIQUES
  # ========================================
  - name: technical_alerts
    rules:
      # 1. Service indisponible (up == 0)
      - alert: ServiceIndisponible
        expr: up == 0
        for: 0s  # Alerte imm√©diate
        labels:
          severity: critical
          category: technique
        annotations:
          summary: "üö® Service {{ $labels.job }} indisponible"
          description: "Le service {{ $labels.job }} ne r√©pond plus (up == 0)"

      # 2. Taux d'erreurs HTTP > 10% sur 5 minutes
      - alert: TauxErreurHTTPEleve
        expr: (rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m])) * 100 > 10
        for: 0s  # D√®s que le seuil est d√©pass√©
        labels:
          severity: critical
          category: technique
        annotations:
          summary: "üö® Taux d'erreur HTTP √©lev√© sur {{ $labels.job }}"
          description: "{{ $labels.job }} a {{ $value | printf \"%.1f\" }}% d'erreurs HTTP sur les 5 derni√®res minutes (seuil: 10%)"

      # 3. Temps de r√©ponse moyen > 2 secondes
      - alert: TempsReponseEleve
        expr: (rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])) > 2
        for: 1m
        labels:
          severity: warning
          category: technique
        annotations:
          summary: "‚ö†Ô∏è Temps de r√©ponse √©lev√© sur {{ $labels.job }}"
          description: "{{ $labels.job }} a un temps de r√©ponse moyen de {{ $value | printf \"%.2f\" }}s (seuil: 2s)"

      # 4. CPU > 80%
      - alert: CPUEleve
        expr: process_cpu_usage_percent > 80
        for: 2m
        labels:
          severity: warning
          category: technique
        annotations:
          summary: "‚ö†Ô∏è Utilisation CPU √©lev√©e sur {{ $labels.job }}"
          description: "{{ $labels.job }} utilise {{ $value | printf \"%.1f\" }}% de CPU (seuil: 80%)"

  # ========================================
  # ALERTES M√âTIER
  # ========================================
  - name: business_alerts
    rules:
      # 1. Trop d'√©checs de connexion (suspicion d'attaque ou bug)
      - alert: EchecsConnexionSuspects
        expr: rate(auth_attempts_total{method="login",success="false"}[2m]) > 0.5  # Plus de 30 √©checs par minute
        for: 1m
        labels:
          severity: critical
          category: metier
        annotations:
          summary: "üö® Pic d'√©checs de connexion suspect"
          description: "{{ $value | humanize }} √©checs de connexion par seconde d√©tect√©s - Possible attaque ou bug (seuil: 0.5/s)"

      # 2. Taux d'erreur √©lev√© sur l'IA (OpenAI indisponible)
      - alert: IAIndisponible
        expr: (rate(openai_requests_total{status="error"}[5m]) / rate(openai_requests_total[5m])) * 100 > 20
        for: 1m
        labels:
          severity: critical
          category: metier
        annotations:
          summary: "üö® Service IA d√©faillant"
          description: "{{ $value | printf \"%.1f\" }}% des requ√™tes OpenAI √©chouent - Service IA potentiellement indisponible (seuil: 20%)"

      # 3. Transactions de paiement √©chou√©es
      - alert: PaiementsEchoues
        expr: (rate(http_requests_total{job="payment-service",status_code=~"4..|5.."}[5m]) / rate(http_requests_total{job="payment-service"}[5m])) * 100 > 5
        for: 1m
        labels:
          severity: critical
          category: metier
        annotations:
          summary: "üö® √âchecs de paiement d√©tect√©s"
          description: "{{ $value | printf \"%.1f\" }}% des transactions de paiement √©chouent (seuil: 5%)"

  # ========================================
  # ALERTES COMPL√âMENTAIRES
  # ========================================
  - name: additional_alerts
    rules:
      # M√©moire √©lev√©e
      - alert: MemoireElevee
        expr: (process_memory_usage_bytes / 1024 / 1024) > 512  # Plus de 512MB
        for: 5m
        labels:
          severity: warning
          category: technique
        annotations:
          summary: "‚ö†Ô∏è Utilisation m√©moire √©lev√©e sur {{ $labels.job }}"
          description: "{{ $labels.job }} utilise {{ $value | printf \"%.0f\" }}MB de m√©moire (seuil: 512MB)"

      # Quiz prenant trop de temps
      - alert: QuizTropLents
        expr: (rate(quiz_generation_duration_seconds_sum{type="quiz_generation"}[5m]) / rate(quiz_generation_duration_seconds_count{type="quiz_generation"}[5m])) > 15
        for: 2m
        labels:
          severity: warning
          category: metier
        annotations:
          summary: "‚ö†Ô∏è G√©n√©ration de quiz lente"
          description: "La g√©n√©ration de quiz prend en moyenne {{ $value | printf \"%.1f\" }}s (seuil: 15s)"
